# 分布式锁测试说明

## 测试环境准备

1. **启动Redis服务**
```bash
redis-server --port 6379
```

2. **确保Go环境正常**
```bash
go version
```

## 测试方法

### 方法1：使用测试脚本（推荐）

```bash
# Windows
test_runner.bat

# 或手动运行
go run test_lock.go <进程ID> <测试类型>
```

### 方法2：手动测试

#### 1. 并发测试
测试多个进程同时获取锁的互斥性：

```bash
# 终端1
go run test_lock.go process1 concurrent

# 终端2（立即运行）
go run test_lock.go process2 concurrent

# 终端3（立即运行）
go run test_lock.go process3 concurrent
```

**预期结果**：
- 只有一个进程能成功获取锁
- 其他进程会显示"获取锁失败"
- 获取锁的进程会执行完业务逻辑后释放锁

#### 2. 安全性测试
测试锁的安全机制，防止误删：

```bash
# 终端1
go run test_lock.go safety1 safety

# 终端2（立即运行）
go run test_lock.go safety2 safety
```

**预期结果**：
- 用错误值释放锁会失败
- 用正确值释放锁会成功
- 只有锁的持有者才能释放锁

#### 3. 超时测试
测试锁的自动过期机制：

```bash
go run test_lock.go timeout1 timeout
```

**预期结果**：
- 锁会在指定时间后自动过期
- 尝试释放已过期的锁会失败

## 测试场景说明

### 场景1：并发竞争
- **目的**：验证锁的互斥性
- **操作**：多个进程同时尝试获取同一个锁
- **预期**：只有一个进程成功，其他失败

### 场景2：锁安全性
- **目的**：验证锁不会被误删
- **操作**：用错误的值尝试释放锁
- **预期**：释放失败，锁保持安全

### 场景3：锁超时
- **目的**：验证锁的自动过期
- **操作**：获取锁后等待超时
- **预期**：锁自动过期，无法释放

### 场景4：锁续期
- **目的**：验证长时间业务处理
- **操作**：获取锁后执行长时间业务
- **预期**：锁在业务完成前保持有效

## 观察要点

1. **互斥性**：同一时间只有一个进程能获取锁
2. **安全性**：只有锁的持有者能释放锁
3. **超时性**：锁会在指定时间后自动过期
4. **原子性**：获取和释放锁的操作是原子的

## 常见问题

### Q: 所有进程都获取锁失败？
A: 检查Redis服务是否正常运行，端口是否正确

### Q: 锁释放失败？
A: 检查锁是否已过期，或值是否匹配

### Q: 测试结果不符合预期？
A: 检查Redis连接，确保没有其他程序干扰测试
